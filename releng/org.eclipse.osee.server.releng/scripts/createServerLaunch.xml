<project name="Generates OSEE Application Server Launch Script" default="noDefault">

	<!-- Dummy Default -->
	<target name="noDefault">
		<echo message="You must specify a target when invoking this file" />
	</target>

	<!-- Dependencies
	<property name="launcherJar" value="org.eclipse.equinox.launcher_1.0.201.R35x_v20090715.jar" />
	<property name="pluginsFolder" value="${eclipse.home}/plugins" />
	<property name="tempAppServerFolder" value="${ant.file}/../.." />
	<property name="ant.contrib.home" value="/tmp/build/3rdPartyJars/" />
	-->

	<loadfile property="prelaunchScript" encoding="utf-8" failonerror="true" srcfile="${relengBuilderDir}/scripts/pre_server_launch_template.txt" />
	<loadfile property="postlaunchScript" encoding="utf-8" failonerror="true" srcfile="${relengBuilderDir}/scripts/post_server_launch_template.txt" />

	<target name="generateTemplate">
		<generate.launch connection.id="[id from connection file]" extraVMArgs="-Dosee.connection.info.uri=[custom connection file path] -Dosee.application.server.data=[binary data path]" filepath="${tempAppServerFolder}/runExample.sh" isexecutable="false" launcher="${launcherJar}" serverport="8089" servertelnetport="8090" />
	</target>

	<target name="generateDerbyLaunch">
		<generate.launch connection.id="derby" extraVMArgs="-Dosee.derby.server=127.0.0.1:1621" filepath="${tempAppServerFolder}/runDerby.sh" launcher="${launcherJar}" serverport="8089" servertelnetport="8090" />
	</target>

	<target name="generateLocalPostgresLaunch">
		<generate.launch connection.id="postgresqlLocalhost" filepath="${tempAppServerFolder}/runPostgresqlLocal.sh" launcher="${launcherJar}" serverport="8089" servertelnetport="8090" />
	</target>

	<target name="generateAll" depends="generateLocalPostgresLaunch,generateDerbyLaunch,generateTemplate">
	</target>

	<macrodef name="generate.launch">
		<attribute name="filePath" />
		<attribute name="launcher" />
		<attribute name="serverPort" />
		<attribute name="serverTelnetPort" />
		<attribute name="serverMaxMem" default="1024m" />
		<attribute name="connection.id" />
		<attribute name="extraVMArgs" default=" " />
		<attribute name="extraArgs" default="-configuration configuration" />
		<attribute name="isExecutable" default="true" />
		<attribute name="extraScript" default=" " />
		<sequential>
			<echo message="Launcher was ${launcherJar}" />
			<echo file="@{filePath}" append="false" message="${prelaunchScript}" />
			<echo file="@{filePath}" append="true">
#######################################################################
## Custom Config				
EQUINOX_LAUNCHER=@{launcher}
OSEE_DATABASE_CONNECTION_ID=@{connection.id}
OSEE_SERVER_MAX_MEMORY=@{serverMaxMem}
OSEE_APP_SERVER_PORT=@{serverPort}
OSGI_TELNET_PORT=@{serverTelnetPort}
OSEE_APP_SERVER_EXTRA_VMARGS=@{extraVMArgs}
OSEE_APP_ARGS=@{extraArgs}
@{extraScript}	
######################################################################
			</echo>
			<echo file="@{filePath}" append="true" message="${postlaunchScript}" />
			<if>
				<equals arg1="@{isExecutable}" arg2="true" />
				<then>
					<chmod file="@{filePath}" perm="ugo+rx" />
				</then>
			</if>
		</sequential>
	</macrodef>
</project>