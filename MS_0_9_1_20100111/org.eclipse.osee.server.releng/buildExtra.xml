<project name="Contribute Extra Build Steps" default="noDefault">

	<!-- Dummy Default -->
	<target name="noDefault">
		<echo message="You must specify a target when invoking this file" />
	</target>

	<!-- ////////////////////////////////////////////////////////////////////// -->
	<!-- OSEE BASE EXTRA 											            -->
	<!-- ////////////////////////////////////////////////////////////////////// -->
	<target name="getDependencies" />

	<target name="preFetch" if="mapLocation">
		<mkdir dir="${buildDirectory}/maps" />
		<for param="additionalMapFile" delimiter="," list="${mapLocation}">
			<sequential>
				<propertyregex property="resourceName" override="true" input="@{additionalMapFile}" regexp="[^/}]+$" select="\0" casesensitive="false" />
				<get dest="${buildDirectory}/maps/${resourceName}" src="@{additionalMapFile}" />
				<concat destfile="${buildDirectory}/directory.txt" append="true" fixlastline="yes">
					<fileset file="${buildDirectory}/maps/${resourceName}" />
				</concat>
			</sequential>
		</for>
	</target>

	<target name="postFetch" />
	<target name="preGenerate" />
	<target name="postGenerate" />
	<target name="preAssemble" />
	<target name="postAssemble" />
	<target name="prePackage" />
	<target name="postPackage" />
	<target name="preProcess" />
	<target name="postProcess" />
	<target name="postBuild" />

	<target name="extraPackaging">
		<propertyregex property="updateSiteFile" input="${masterZip}" defaultvalue="${masterZip}" regexp="-Master-" replace="-Update-" casesensitive="false" override="true" />
		<property name="tempAppServerFolder" value="${buildDirectory}/${buildLabel}/${updateSiteFile}_tmp" />
		<mkdir dir="${tempAppServerFolder}" />
		<unzip src="${buildDirectory}/${buildLabel}/${updateSiteFile}" dest="${tempAppServerFolder}">
			<patternset includes="plugins/*" excludes="features/*,*.jar,*.xml" />
		</unzip>
		<mkdir dir="${tempAppServerFolder}/configuration" />

		<property name="configFolder" value="${tempAppServerFolder}/configuration" />
		<property name="pluginsFolder" value="${tempAppServerFolder}/plugins" />
		<antcall target="generateConfigIni" inheritall="true" />
		<antcall target="generateLaunchScripts" inheritall="true" />

		<propertyregex property="serverRuntimeFile" input="${updateSiteFile}" defaultvalue="server-runtime.zip" regexp="-Update-" replace="-Application-Server-" casesensitive="false" override="true" />

		<zip destfile="${buildDirectory}/${buildLabel}/${serverRuntimeFile}">
			<fileset dir="${tempAppServerFolder}" />
		</zip>
		<delete dir="${tempAppServerFolder}" quiet="true" />
		<antcall target="deleteZips" inheritall="true" />
	</target>

	<target name="generateLaunchScripts">
		<pathconvert property="launcherBundlePath" setonempty="false">
			<path>
				<fileset dir="${pluginsFolder}">
					<include name="org.eclipse.equinox.launcher_*.jar" />
				</fileset>
			</path>
		</pathconvert>
		<propertyregex property="launcherJar" override="true" input="${launcherBundlePath}" regexp="[^${file.separator}]+$" select="\0" casesensitive="false" />
		
		<generate.launch 
			name="runDerby.sh" 
			executable="true" 
			port="8089" 
			connection.id="derby" 
			args="-Dosee.derby.server=127.0.0.1:1621" />

		<generate.launch 
			name="runPostgresqlLocal.sh" 
			executable="true" 
			port="8089" 
			connection.id="postgresqlLocalhost" 
			args=" " />

		<generate.launch 
			name="runExample.sh" 
			executable="false" 
			port="8089" 
			connection.id="[id from connection file]" 
			args="-Dosee.connection.info.uri=[custom connection file path] -Dosee.application.server.data=[binary data path]" />

	</target>

	<macrodef name="generate.launch">
		<attribute name="name" />
		<attribute name="port" />
		<attribute name="executable" />
		<attribute name="connection.id" />
		<attribute name="args" />
		<sequential>
			<echo file="${tempAppServerFolder}/@{name}" append="false">java \
-Dorg.osgi.service.http.port=@{port} \
-Dosee.check.tag.queue.on.startup=true \
-Dosee.db.connection.id=@{connection.id} \				
@{args} \
-jar plugins/${launcherJar} -console
</echo>
			<if>
				<equals arg1="executable" arg2="true" />
				<then>
					<chmod file="${tempAppServerFolder}/@{name}" perm="ugo+rx" />
				</then>
			</if>
		</sequential>
	</macrodef>

	<target name="deleteZips">
		<echo message="deleteZips" />
		<propertyregex property="allZip" input="${updateSiteFile}" defaultvalue="" regexp="-Update-" replace="-AllFeaturesAndPlugins-" casesensitive="false" override="true" />
		<propertyregex property="sdkZip" input="${updateSiteFile}" defaultvalue="" regexp="-Update-" replace="-SDK-" casesensitive="false" override="true" />

		<delete file="${buildDirectory}/${buildLabel}/${allZip}" quiet="true" />
		<delete file="${buildDirectory}/${buildLabel}/${allZip}.md5" quiet="true" />
		<delete file="${buildDirectory}/${buildLabel}/${sdkZip}" quiet="true" />
		<delete file="${buildDirectory}/${buildLabel}/${sdkZip}.md5" quiet="true" />
	</target>

	<target name="generateConfigIni">
		<echo file="${configFolder}/config.ini" append="false" message="osgi.bundles= \${line.separator}\${line.separator}" />

		<pathconvert property="serverBundles" setonempty="false" pathsep=";">
			<path>
				<fileset dir="${pluginsFolder}">
					<exclude name="org.eclipse.osgi_*.jar" />
					<exclude name="org.eclipse.equinox.launcher_*.jar" />
				</fileset>
			</path>
		</pathconvert>

		<var name="isFirst" value="false" />
		<for param="bundle" delimiter=";" list="${serverBundles}" trim="true">
			<sequential>
				<propertyregex property="projectAndVersion" override="true" input="@{bundle}" regexp="[^${file.separator}]+$" select="\0" casesensitive="false" />
				<propertyregex property="projectName" override="true" input="${projectAndVersion}" regexp="(.*?)_" select="\1" casesensitive="false" />
				<if>
					<equals arg1="${isFirst}" arg2="true" />
					<then>
						<echo file="${configFolder}/config.ini" message=", \${line.separator}" append="true" />
						<var name="isFirst" value="false" />
					</then>
				</if>
				<echo file="${configFolder}/config.ini" message="${projectName}@start" append="true" />
				<var name="isFirst" value="true" />
			</sequential>
		</for>
		<echo file="${configFolder}/config.ini" append="true">
osgi.noShutdown=true
eclipse.ignoreApp=true
equinox.ds.debug=true
osee.log.default=INFO${line.separator}</echo>
	</target>
</project>
